{% extends "base.html" %}
{% block content %}
<div class="dashboard-container">
    <h2>{{ course|yesno:"Izmeni,Dodaj novi" }} kurs</h2>
    
    <form method="POST" enctype="multipart/form-data" class="course-form">
        {% csrf_token %}
        
        <!-- Basic Course Information -->
        <div class="form-section">
            <div class="form-group">
                <label for="title">Course Title:</label>
                <input type="text" id="title" name="title" required>
            </div>

            <div class="form-group">
                <label for="main-category">Category:</label>
                <select id="main-category" name="main-category" class="form-control" required>
                    <option value="">Select Category</option>
                    {% for code, name in main_categories.items %}
                        <option value="{{ code }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="topic">Subcategory:</label>
                <select id="topic" name="topic" class="form-control" required>
                    <option value="">Select Subcategory</option>
                </select>
            </div>

            <div class="form-group">
                <label for="language">Language:</label>
                <select id="language" name="language" required>
                    {% for code, name in language_choices %}
                        <option value="{{ code }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" name="description" required></textarea>
            </div>

            <div class="form-group">
                <label for="price">Price:</label>
                <input type="number" id="price" name="price" value="0" min="0" step="0.01">
            </div>

            <div class="form-group">
                <label for="image">Course Image:</label>
                <input type="file" id="image" name="image" accept="image/*" required>
            </div>
        </div>

        <!-- Course Content Section -->
        <div class="course-content">
            <h3>Course Content</h3>
            <div class="sections-container">
                <!-- Sections will be added here -->
            </div>
            <button type="button" class="btn-add-section" onclick="addSection()">+ Add Section</button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Create Course</button>
            <a href="{% url 'admin_dashboard' %}" class="btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Templates -->
<template id="section-template">
    <div class="section-item">
        <div class="section-header">
            <input type="text" name="section_title[]" placeholder="Section Title" required>
            <input type="hidden" name="section_order[]" value="">
            <button type="button" onclick="removeSection(this)" class="btn-remove">×</button>
        </div>
        <div class="lessons-container">
            <!-- Lessons will be added here -->
        </div>
        <button type="button" onclick="addLesson(this)" class="btn-add-lesson">+ Add Lesson</button>
    </div>
</template>

<template id="lesson-template">
    <div class="lesson-item">
        <input type="text" name="lesson_title[]" placeholder="Lesson Title" required>
        <input type="text" name="lesson_video[]" placeholder="Video URL">
        <textarea name="lesson_content[]" placeholder="Lesson Content"></textarea>
        <input type="hidden" name="lesson_section[]" value="">
        <button type="button" onclick="removeLesson(this)" class="btn-remove">×</button>
    </div>
</template>


<script>
const subcategories = {{ subcategories|safe }};

function updateSubcategories() {
    const mainCategory = document.getElementById('main-category').value;
    const subcategorySelect = document.getElementById('topic');
    
    // Clear existing options
    subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
    
    if (mainCategory && subcategories[mainCategory]) {
        subcategories[mainCategory].forEach(subcat => {
            const option = document.createElement('option');
            option.value = subcat;
            option.textContent = subcat;
            subcategorySelect.appendChild(option);
        });
    }
}

// Add event listener for category change
document.getElementById('main-category').addEventListener('change', updateSubcategories);

// Functions for sections and lessons
let sectionCounter = 0;

function addSection() {
    const template = document.getElementById('section-template');
    const container = document.querySelector('.sections-container');
    const clone = template.content.cloneNode(true);
    
    sectionCounter++;
    clone.querySelector('input[name="section_order[]"]').value = sectionCounter;
    
    container.appendChild(clone);
}

function addLesson(button) {
    const sectionItem = button.closest('.section-item');
    const sectionIndex = Array.from(document.querySelectorAll('.section-item')).indexOf(sectionItem);
    const lessonsContainer = sectionItem.querySelector('.lessons-container');
    
    const template = document.getElementById('lesson-template');
    const clone = template.content.cloneNode(true);
    
    // Update the names to include section index
    clone.querySelector('input[name="lesson_title[]"]').name = `lesson_title[${sectionIndex}][]`;
    clone.querySelector('input[name="lesson_video[]"]').name = `lesson_video[${sectionIndex}][]`;
    clone.querySelector('textarea[name="lesson_content[]"]').name = `lesson_content[${sectionIndex}][]`;
    
    lessonsContainer.appendChild(clone);
}

function removeSection(button) {
    button.closest('.section-item').remove();
}

function removeLesson(button) {
    button.closest('.lesson-item').remove();
}

// Add initial section
document.addEventListener('DOMContentLoaded', function() {
    addSection();
});
</script>
{% endblock %} 